"0",""
"0","# File path to your Excel file (the one you just uploaded)"
"0","san_joaquin_file_path <- ""historical_data/historical_data_full.xlsx"""
"0",""
"0","# Determine the current month and year"
"0","san_joaquin_current_month <- format(Sys.Date(), ""%b"")"
"0","san_joaquin_current_year <- format(Sys.Date(), ""%Y"")"
"0",""
"0","# Load the entire workbook without overwriting other sheets"
"0","san_joaquin_workbook <- loadWorkbook(san_joaquin_file_path)"
"0",""
"0","# Read the specific sheet you want to update"
"0","san_joaquin_historical_data <- readWorkbook(san_joaquin_workbook, sheet = ""Flow_SanJoaq"")"
"0","san_joaquin_historical_data$Year <- as.character(san_joaquin_historical_data$Year) # Ensure Year is character"
"0",""
"0","# Define the start and end dates for the current month"
"0","san_joaquin_start_date <- floor_date(Sys.Date(), ""month"")"
"0","san_joaquin_end_date <- Sys.Date()"
"0",""
"0","# Query CDEC data for San Joaquin at Vernalis (station ""VNS"") for the current month"
"0","# Assuming `cdec_query` returns a data frame with a ""parameter_value"" column"
"0","san_joaquin_flow_daily <- cdec_query(station = ""VNS"", sensor_num = 20, "
"0","                                     dur_code = ""H"", start_date = as.character(san_joaquin_start_date), "
"0","                                     end_date = as.character(san_joaquin_end_date))"
"0",""
"0","# Calculate the monthly average for San Joaquin flow"
"0","san_joaquin_export_monthly_average <- mean(san_joaquin_flow_daily$parameter_value, na.rm = TRUE)"
"0",""
"0","# Calculate the historical mean for the current month, if available in your data"
"0","san_joaquin_current_month_historical_data <- san_joaquin_historical_data %>%"
"0","  filter(Month == san_joaquin_current_month) %>%"
"0","  select(Average_Flow_Daily)"
"0",""
"0","san_joaquin_current_month_historical_mean <- mean(san_joaquin_current_month_historical_data$Average_Flow_Daily, na.rm = TRUE)"
"0",""
"0","# Calculate the percentage of the current monthâ€™s average relative to the historical average"
"0","san_joaquin_percentage_of_cfs_average <- (san_joaquin_export_monthly_average / san_joaquin_current_month_historical_mean) * 100"
"0",""
"0","# Print only the percentage result"
"0","message(sprintf(""San Joaquin export monthly average is %.2f%% of the historical average for %s"", "
"0","                san_joaquin_percentage_of_cfs_average, san_joaquin_current_month))"
"2","San Joaquin export monthly average is 34.40% of the historical average for Jan
"
"0","# Check if there is an entry for the current month and year"
"0","existing_entry <- san_joaquin_historical_data %>%"
"0","  filter(Month == san_joaquin_current_month, Year == san_joaquin_current_year)"
"0",""
"0","suppressMessages({"
"0","  if (nrow(existing_entry) > 0) {"
"0","    # Update the existing row with the new flow average for the current month"
"0","    row_to_update <- which(san_joaquin_historical_data$Month == san_joaquin_current_month & "
"0","                           san_joaquin_historical_data$Year == san_joaquin_current_year)"
"0","    san_joaquin_historical_data[row_to_update, ""Average_Flow_Daily""] <- san_joaquin_export_monthly_average"
"0","  } else {"
"0","    # Create a new row with the current month, year, and flow average if it's a new month"
"0","    new_row <- data.frame("
"0","      Month = san_joaquin_current_month,"
"0","      Year = san_joaquin_current_year,"
"0","      Average_Flow_Daily = san_joaquin_export_monthly_average"
"0","    )"
"0","    "
"0","    # Append the new row to the historical data"
"0","    san_joaquin_historical_data <- bind_rows(san_joaquin_historical_data, new_row)"
"0","  }"
"0","  "
"0","  # Write only the modified sheet back to the workbook"
"0","  writeData(san_joaquin_workbook, sheet = ""Flow_SanJoaq"", x = san_joaquin_historical_data)"
"0","  "
"0","  # Save the workbook, preserving all other sheets"
"0","  saveWorkbook(san_joaquin_workbook, san_joaquin_file_path, overwrite = TRUE)"
"0","})"
"0",""
"0",""
"0",""
